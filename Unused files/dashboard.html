<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PHC Dashboard — Inventory & Tools</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>html,body{height:100%}</style>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen">
  <div class="max-w-7xl mx-auto p-4">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-semibold">PHC Portal — Dashboard</h1>
      <div class="flex items-center gap-3">
        <span id="signed-as" class="text-sm text-gray-600">Not signed in</span>
      </div>
    </header>

    <!-- Nav -->
    <nav class="mb-4">
      <div class="flex gap-2 flex-wrap">
        <button data-tab="inventory" class="tab-btn px-3 py-1 rounded bg-indigo-600 text-white">Inventory</button>
        <button data-tab="patients" class="tab-btn px-3 py-1 rounded bg-white border">Patients</button>
        <button data-tab="workload" class="tab-btn px-3 py-1 rounded bg-white border">Workload</button>
        <button data-tab="feedback" class="tab-btn px-3 py-1 rounded bg-white border">Feedback</button>
        <button data-tab="auth" class="tab-btn px-3 py-1 rounded bg-white border">PHC Auth</button>
      </div>
    </nav>

    <!-- CONTENT PANELS -->
    <main>
      <!-- Inventory panel (existing inventory dashboard) -->
      <section id="inventory" class="panel bg-white p-4 rounded shadow">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-medium">Inventory</h2>
          <div class="flex items-center gap-2">
            <button id="open-add-btn" class="bg-green-600 text-white px-3 py-1 rounded">Add Item</button>
            <button id="show-lowstock-btn" class="bg-yellow-600 text-white px-3 py-1 rounded">Show Low Stock</button>
            <input id="threshold-days" type="number" min="1" value="5" class="w-20 px-2 py-1 rounded border" title="Threshold days"/>
            <button id="create-restock-btn" class="bg-indigo-600 text-white px-3 py-1 rounded">Create Restock Requests</button>
          </div>
        </div>

        <div class="grid md:grid-cols-3 gap-4">
          <div class="md:col-span-2 overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead class="bg-gray-100">
                <tr class="text-left">
                  <th class="px-3 py-2">Item</th><th class="px-3 py-2">Type</th><th class="px-3 py-2">Stock</th>
                  <th class="px-3 py-2">Daily</th><th class="px-3 py-2">Days Left</th><th class="px-3 py-2">Unit</th><th class="px-3 py-2">Action</th>
                </tr>
              </thead>
              <tbody id="inventory-tbody" class="bg-white divide-y divide-gray-100"></tbody>
            </table>

            <div class="flex items-center justify-between mt-3">
              <div class="text-sm">Total items: <span id="total-items">0</span></div>
              <div class="flex items-center gap-2">
                <button id="prev-page" class="px-3 py-1 rounded border bg-white">Prev</button>
                <span id="page-info" class="text-sm"></span>
                <button id="next-page" class="px-3 py-1 rounded border bg-white">Next</button>
              </div>
            </div>
          </div>

          <aside class="bg-gray-50 p-3 rounded">
            <h3 class="font-medium mb-2">Summary</h3>
            <div class="mb-2">Low stock items: <strong id="lowstock-count">0</strong></div>
            <div>Pending restock requests: <strong id="pending-reqs">0</strong></div>
            <div class="mt-3 text-sm text-gray-600">Click Request to create a single restock request for an item.</div>
          </aside>
        </div>
      </section>

      <!-- Patients panel -->
      <section id="patients" class="panel hidden bg-white p-4 rounded shadow">
        <h2 class="text-lg font-medium mb-2">Register Patient</h2>
        <form id="patient-form" class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <input id="p-name" placeholder="Full name" class="px-2 py-1 border rounded" required/>
          <input id="p-age" placeholder="Age" type="number" class="px-2 py-1 border rounded"/>
          <select id="p-sex" class="px-2 py-1 border rounded">
            <option value="">Sex</option><option>Male</option><option>Female</option>
          </select>
          <select id="p-visit" class="px-2 py-1 border rounded">
            <option value="">Visit Type</option><option>Emergency</option><option>Acute</option><option>Routine</option><option>Follow-up</option>
          </select>
          <input id="p-symptoms" placeholder="Symptoms (comma separated)" class="col-span-2 px-2 py-1 border rounded"/>
          <textarea id="p-notes" placeholder="Notes / history" class="col-span-2 px-2 py-1 border rounded"></textarea>
          <div class="col-span-2 flex justify-end gap-2">
            <button type="submit" class="bg-indigo-600 text-white px-3 py-1 rounded">Register</button>
            <button id="triage-btn" type="button" class="bg-gray-200 px-3 py-1 rounded">Run Triage (LLM)</button>
          </div>
        </form>

        <div id="patient-result" class="mt-4 text-sm text-gray-800"></div>
      </section>

      <!-- Workload panel -->
      <section id="workload" class="panel hidden bg-white p-4 rounded shadow">
        <h2 class="text-lg font-medium mb-2">Workload</h2>
        <form id="workload-log-form" class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
          <input id="w-date" type="date" class="px-2 py-1 border rounded"/>
          <input id="w-count" type="number" placeholder="Patients seen" class="px-2 py-1 border rounded"/>
          <input id="w-queue" type="number" placeholder="Current queue" class="px-2 py-1 border rounded" />
          <input id="w-wait" type="number" step="0.1" placeholder="Avg wait (mins)" class="px-2 py-1 border rounded" />
          <input id="w-completed" type="number" placeholder="Completed visits today" class="px-2 py-1 border rounded" />
          <button type="submit" class="bg-green-600 text-white px-3 py-1 rounded">Log</button>
        </form>

        <div class="flex gap-3 items-center mb-3">
          <input id="forecast-phc-id" type="number" value="1" class="px-2 py-1 border rounded w-28" />
          <button id="forecast-btn" class="bg-indigo-600 text-white px-3 py-1 rounded">Forecast Next Day</button>
        </div>

        <div id="forecast-result" class="text-sm text-gray-800"></div>
      </section>

      <!-- Feedback panel -->
      <section id="feedback" class="panel hidden bg-white p-4 rounded shadow">
        <h2 class="text-lg font-medium mb-2">Feedback</h2>
        <form id="feedback-form" class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-3">
          <input id="f-phc-id" type="number" placeholder="PHC ID" class="px-2 py-1 border rounded" value="1"/>
          <input id="f-title" placeholder="Title" class="px-2 py-1 border rounded"/>
          <textarea id="f-body" placeholder="Feedback details" class="col-span-2 px-2 py-1 border rounded"></textarea>
          <div class="col-span-2 flex justify-end gap-2">
            <button type="submit" class="bg-indigo-600 text-white px-3 py-1 rounded">Submit</button>
            <button id="load-feedback" type="button" class="bg-gray-200 px-3 py-1 rounded">Load for PHC</button>
          </div>
        </form>

        <div id="feedback-list" class="space-y-2 text-sm"></div>
      </section>

      <!-- Auth panel -->
      <section id="auth" class="panel hidden bg-white p-4 rounded shadow">
        <h2 class="text-lg font-medium mb-2">PHC Sign-in / Sign-up</h2>
        <div class="grid md:grid-cols-2 gap-3">
          <form id="signup-form" class="space-y-2">
            <input id="su-phc-id" placeholder="PHC ID" class="px-2 py-1 border rounded w-full"/>
            <input id="su-phc-name" placeholder="PHC name" class="px-2 py-1 border rounded w-full"/>
            <input id="su-password" type="password" placeholder="Password" class="px-2 py-1 border rounded w-full"/>
            <div class="flex justify-end"><button class="bg-green-600 text-white px-3 py-1 rounded">Sign up</button></div>
          </form>

          <form id="signin-form" class="space-y-2">
            <input id="si-phc-id" placeholder="PHC ID" class="px-2 py-1 border rounded w-full"/>
            <input id="si-password" type="password" placeholder="Password" class="px-2 py-1 border rounded w-full"/>
            <div class="flex justify-end"><button class="bg-indigo-600 text-white px-3 py-1 rounded">Sign in</button></div>
          </form>
        </div>
        <div id="auth-msg" class="mt-3 text-sm text-gray-800"></div>
      </section>
    </main>
  </div>

  <!-- Add / Update Item Modal (inventory) -->
  <div id="add-modal" class="fixed inset-0 z-40 hidden items-center justify-center bg-black/40 p-4">
    <div class="w-full max-w-md bg-white rounded shadow p-5">
      <h3 class="text-lg font-semibold mb-3">Add / Update Inventory Item</h3>
      <form id="add-item-form" class="space-y-3">
        <div><label class="block text-sm">Item name</label><input id="f-item-name" required class="w-full px-2 py-1 border rounded" /></div>
        <div><label class="block text-sm">Type</label><input id="f-item-type" class="w-full px-2 py-1 border rounded" /></div>
        <div class="grid grid-cols-2 gap-2">
          <div><label class="block text-sm">Quantity</label><input id="f-qty" type="number" min="0" value="0" class="w-full px-2 py-1 border rounded" /></div>
          <div><label class="block text-sm">Unit</label><input id="f-unit" class="w-full px-2 py-1 border rounded" /></div>
        </div>
        <div><label class="block text-sm">Daily consumption (per day)</label><input id="f-daily" type="number" step="0.1" min="0" value="0" class="w-full px-2 py-1 border rounded" /></div>
        <div class="flex justify-end space-x-2 pt-2">
          <button type="button" id="close-add-btn" class="px-3 py-1 rounded border">Cancel</button>
          <button type="submit" class="px-3 py-1 rounded bg-green-600 text-white">Save</button>
        </div>
      </form>
    </div>
  </div>

<script>
/* Core JS: tabs + API wiring */
const API_BASE = 'http://localhost:8000';
const DEFAULT_PHC_ID = 1;
let currentPage = 1;
const PAGE_SIZE = 50;

/* TABS */
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click', ()=> {
    document.querySelectorAll('.panel').forEach(p=>p.classList.add('hidden'));
    const id = btn.getAttribute('data-tab');
    document.getElementById(id).classList.remove('hidden');
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('bg-indigo-600','text-white'));
    btn.classList.add('bg-indigo-600','text-white');
  });
});
/* default show inventory */
document.querySelector('.tab-btn[data-tab="inventory"]').click();

/* Utility */
const esc = s => s ? String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) : '';

/* ============ Inventory functions (same as earlier) ============ */
const tbody = document.getElementById('inventory-tbody');
const totalEl = document.getElementById('total-items');
const lowstockEl = document.getElementById('lowstock-count');
const pendingEl = document.getElementById('pending-reqs');
const pageInfo = document.getElementById('page-info');

document.getElementById('open-add-btn').addEventListener('click', ()=>document.getElementById('add-modal').classList.remove('hidden'));
document.getElementById('close-add-btn').addEventListener('click', ()=>document.getElementById('add-modal').classList.add('hidden'));
document.getElementById('prev-page').addEventListener('click', ()=>{ if (currentPage>1) loadInventory(currentPage-1); });
document.getElementById('next-page').addEventListener('click', ()=>{ const pages=Math.max(1,Math.ceil((+totalEl.textContent||0)/PAGE_SIZE)); if (currentPage<pages) loadInventory(currentPage+1); });
document.getElementById('show-lowstock-btn').addEventListener('click', showLowStock);
document.getElementById('create-restock-btn').addEventListener('click', createRestockForThreshold);

document.getElementById('add-item-form').addEventListener('submit', async e=>{
  e.preventDefault();
  const payload = {
    item_name: document.getElementById('f-item-name').value.trim(),
    item_type: document.getElementById('f-item-type').value.trim() || undefined,
    add_quantity: Number(document.getElementById('f-qty').value) || 0,
    daily_consumption_rate: Number(document.getElementById('f-daily').value) || 0,
    unit: document.getElementById('f-unit').value.trim() || undefined,
    phc_id: DEFAULT_PHC_ID,
    phc_name: 'PHC A'
  };
  try {
    const res = await fetch(API_BASE + '/inventory/add-item', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    if (!res.ok) throw new Error('Save failed');
    await Promise.all([loadInventory(currentPage), refreshSummary()]);
    document.getElementById('add-modal').classList.add('hidden');
  } catch(e){ console.error(e); alert('Failed to save item'); }
});

async function loadInventory(page=1){
  currentPage = page;
  try {
    const res = await fetch(`${API_BASE}/inventory/items?page=${page}&page_size=${PAGE_SIZE}&phc_id=${DEFAULT_PHC_ID}`);
    if (!res.ok) throw new Error('Failed to load');
    const json = await res.json();
    totalEl.textContent = json.total ?? 0;
    renderInventory(json.items || []);
    const pages = Math.max(1, Math.ceil((json.total||0)/PAGE_SIZE));
    pageInfo.textContent = `Page ${currentPage} / ${pages}`;
  } catch(e){
    console.error(e);
    tbody.innerHTML = '<tr><td colspan="7" class="p-3 text-red-600">Error loading inventory</td></tr>';
  }
}

function renderInventory(items){
  tbody.innerHTML = '';
  if (!items.length) { tbody.innerHTML = '<tr><td colspan="7" class="p-3 text-gray-500">No items</td></tr>'; return; }
  for (const it of items){
    const days = (it.days_remaining !== null && it.days_remaining !== undefined) ? it.days_remaining : '-';
    const tr = document.createElement('tr'); tr.className='hover:bg-gray-50';
    tr.innerHTML = `<td class="px-3 py-2">${esc(it.item_name)}</td><td class="px-3 py-2">${esc(it.item_type||'')}</td>
      <td class="px-3 py-2">${it.current_stock??0}</td><td class="px-3 py-2">${it.daily_consumption_rate??'-'}</td>
      <td class="px-3 py-2">${days}</td><td class="px-3 py-2">${esc(it.unit||'')}</td>
      <td class="px-3 py-2"><button class="text-indigo-600 hover:underline btn-request">Request</button></td>`;
    tr.querySelector('.btn-request').addEventListener('click', ()=>requestRestock(it));
    tbody.appendChild(tr);
  }
}

async function requestRestock(item){
  const suggested = item.daily_consumption_rate ? Math.max(1, Math.round(item.daily_consumption_rate*7)) : Math.max(1, item.current_stock||1);
  const payload = { item_name: item.item_name, quantity_needed: suggested, phc_id: item.phc_id||DEFAULT_PHC_ID, phc_name: item.phc_name||'PHC A' };
  try{
    const res = await fetch(API_BASE + '/inventory/restock-requests', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    if (!res.ok) throw new Error('Request failed');
    await refreshSummary(); alert('Restock requested');
  } catch(e){ console.error(e); alert('Failed to create restock request'); }
}

async function showLowStock(){
  const thr = Number(document.getElementById('threshold-days').value) || 5;
  try {
    const res = await fetch(`${API_BASE}/inventory/low-stock?threshold_days=${thr}&phc_id=${DEFAULT_PHC_ID}`);
    if (!res.ok) throw new Error('Failed');
    const items = await res.json();
    renderInventory(items);
    lowstockEl.textContent = items.length ?? 0;
  } catch(e){ console.error(e); alert('Error fetching low stock'); }
}

async function createRestockForThreshold(){
  const thr = Number(document.getElementById('threshold-days').value) || 5;
  try {
    const res = await fetch(`${API_BASE}/inventory/create-restock-for-threshold?threshold_days=${thr}&phc_id=${DEFAULT_PHC_ID}`, { method:'POST' });
    if (!res.ok) { const txt = await res.text(); throw new Error(txt||'Failed'); }
    const json = await res.json();
    alert((json.created??0) + ' requests created');
    await refreshSummary(); await loadInventory(currentPage);
  } catch(e){ console.error(e); alert('Error creating requests'); }
}

/* refresh summary */
async function refreshSummary(){
  try {
    const resTotal = await fetch(`${API_BASE}/inventory/items?page=1&page_size=1&phc_id=${DEFAULT_PHC_ID}`);
    if (resTotal.ok){ const js = await resTotal.json(); totalEl.textContent = js.total ?? 0; }
    const thr = Number(document.getElementById('threshold-days').value)||5;
    const resLow = await fetch(`${API_BASE}/inventory/low-stock?threshold_days=${thr}&phc_id=${DEFAULT_PHC_ID}`);
    if (resLow.ok){ const low = await resLow.json(); lowstockEl.textContent = low.length ?? 0; }
    const resReq = await fetch(`${API_BASE}/inventory/restock-requests`);
    if (resReq.ok){ const reqs = await resReq.json(); pendingEl.textContent = reqs.filter(r=>r.status==='pending').length; }
  } catch(e){ console.error('summary refresh failed', e); }
}

/* ============ Patients: register + triage ============ */
document.getElementById('patient-form').addEventListener('submit', async e=>{
  e.preventDefault();
  const payload = {
    full_name: document.getElementById('p-name').value.trim(),
    age: Number(document.getElementById('p-age').value) || undefined,
    sex: document.getElementById('p-sex').value || undefined,
    visit_type: document.getElementById('p-visit').value || undefined,
    symptoms: (document.getElementById('p-symptoms').value || '').split(',').map(s=>s.trim()).filter(Boolean),
    notes: document.getElementById('p-notes').value || ''
  };
  try{
    const res = await fetch(API_BASE + '/patients/', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    const js = await res.json();
    document.getElementById('patient-result').textContent = res.ok ? `Created patient id: ${js.id || js.patient_id || 'n/a'}` : `Error: ${js.detail || JSON.stringify(js)}`;
  }catch(e){ console.error(e); document.getElementById('patient-result').textContent='Failed to register'; }
});

/* triage (calls LLM-backed endpoint if available) */
document.getElementById('triage-btn').addEventListener('click', async ()=>{
  const name = document.getElementById('p-name').value.trim();
  if (!name) return alert('Enter patient name and register first');
  // attempt to find patient by name - simplified: call POST triage for last patient id isn't guaranteed
  alert('Triage: call the /patients/triage/{id} endpoint after registration (manual step).');
});

/* ============ Workload log + forecast ============ */
document.getElementById('workload-log-form').addEventListener('submit', async e=>{
  e.preventDefault();
  const payload = {
    phc_id: DEFAULT_PHC_ID,
    date: document.getElementById('w-date').value || undefined,
    patient_count: Number(document.getElementById('w-count').value) || 0,
    current_queue_count: Number(document.getElementById('w-queue').value) || 0,
    avg_wait_time: Number(document.getElementById('w-wait').value) || 0,
    completed_visits_today: Number(document.getElementById('w-completed').value) || 0
  };
  try {
    const res = await fetch(API_BASE + '/workload/log', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    const js = await res.json();
    document.getElementById('forecast-result').textContent = res.ok ? 'Logged workload.' : `Error: ${JSON.stringify(js)}`;
  } catch(e){ console.error(e); alert('Failed to log workload'); }
});

document.getElementById('forecast-btn').addEventListener('click', async ()=>{
  const phc = Number(document.getElementById('forecast-phc-id').value) || DEFAULT_PHC_ID;
  try {
    const res = await fetch(`${API_BASE}/workload/forecast/${phc}`, { method:'POST' });
    const js = await res.json();
    if (!res.ok) { document.getElementById('forecast-result').textContent = 'Forecast error: ' + JSON.stringify(js); return; }
    document.getElementById('forecast-result').textContent = `Forecast: ${JSON.stringify(js)}`;
  } catch(e){ console.error(e); alert('Forecast failed'); }
});

/* ============ Feedback ============ */
document.getElementById('feedback-form').addEventListener('submit', async e=>{
  e.preventDefault();
  const phcId = Number(document.getElementById('f-phc-id').value) || DEFAULT_PHC_ID;
  const title = document.getElementById('f-title').value.trim();
  const body = document.getElementById('f-body').value.trim();

  // API expects phc_name, category and message fields — provide sensible defaults
  const payload = {
    phc_id: phcId,
    phc_name: 'PHC A',          // change to actual PHC name when available
    category: 'General',       // you can add a category input if needed
    title: title,
    message: body
  };

  try {
    const res = await fetch(API_BASE + '/feedback/', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    });
    const js = await res.json();
    if (res.ok) {
      alert('Feedback submitted');
      document.getElementById('feedback-list').insertAdjacentHTML(
        'afterbegin',
        `<div class="p-2 border rounded"><strong>${esc(js.title || payload.title)}</strong><div class="text-sm">${esc(js.message || payload.message)}</div></div>`
      );
    } else {
      alert('Feedback error: ' + JSON.stringify(js));
    }
  } catch (e) {
    console.error(e);
    alert('Failed to submit feedback');
  }
});

document.getElementById('load-feedback').addEventListener('click', async ()=>{
  const phc = Number(document.getElementById('f-phc-id').value)||DEFAULT_PHC_ID;
  try {
    const res = await fetch(`${API_BASE}/feedback/${phc}`);
    const js = await res.json();
    const list = document.getElementById('feedback-list');
    list.innerHTML = '';
    if (Array.isArray(js)) js.forEach(f => list.insertAdjacentHTML('beforeend', `<div class="p-2 border rounded"><strong>${esc(f.title||'')}</strong><div class="text-sm">${esc(f.body||'')}</div></div>`));
    else list.textContent = JSON.stringify(js);
  } catch(e){ console.error(e); alert('Failed to load feedback'); }
});

/* ============ Auth: sign-up / sign-in (no token management, UI only) ============ */
document.getElementById('signup-form').addEventListener('submit', async e=>{
  e.preventDefault();
  const payload = { phc_id: document.getElementById('su-phc-id').value.trim(), phc_name: document.getElementById('su-phc-name').value.trim(), password: document.getElementById('su-password').value };
  try {
    const res = await fetch(`${API_BASE}/phc/sign-up`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    const js = await res.json();
    document.getElementById('auth-msg').textContent = res.ok ? `Signed up: ${js.phc_name||'ok'}` : `Error: ${JSON.stringify(js)}`;
  } catch(e){ console.error(e); alert('Signup failed'); }
});

document.getElementById('signin-form').addEventListener('submit', async e=>{
  e.preventDefault();
  const payload = { phc_id: document.getElementById('si-phc-id').value.trim(), password: document.getElementById('si-password').value };
  try {
    const res = await fetch(`${API_BASE}/phc/sign-in`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    const js = await res.json();
    if (res.ok) {
      document.getElementById('signed-as').textContent = `Signed in as ${js.phc_name || payload.phc_id}`;
      document.getElementById('auth-msg').textContent = 'Signed in';
    } else {
      document.getElementById('auth-msg').textContent = `Sign-in failed: ${JSON.stringify(js)}`;
    }
  } catch(e){ console.error(e); alert('Signin failed'); }
});

/* init */
(async function init(){
  await Promise.all([refreshSummary(), loadInventory(1)]);
})();
</script>
</body>
</html>